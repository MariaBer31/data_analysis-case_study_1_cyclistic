---
title: "How does a bike-share navigate speedy success?"
author: "Mariia Berjoza"
date: "2024-08-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(lubridate)
library(leaflet)
library(tidyr)
library(ggplot2)
library(knitr)
library(kableExtra)
```

#### Data Source
The data used in this analysis is referring to [this resource]("https://divvy-tripdata.s3.amazonaws.com/index.html").
Note: The datasets have a different name because Cyclistic is a fictional company. For the purposes of this case study, the datasets are appropriate and will enable you to answer the business questions. The data has been made available by
Motivate International Inc. under [this license]("https://divvybikes.com/data-license-agreement") 

##### Files used:

* 202407-divvy-tripdata.zip

## Client: Cyclistic

### About company

Cyclistic is a bike-share program that features more than 5,800 bicycles and 600
docking stations. 
Cyclistic sets itself apart by also offering:

* reclining bikes
* hand tricycles
* cargo bikes
 
Cyclistic is making bike-share more inclusive to people with disabilities
and riders who can’t use a standard two-wheeled bike. The majority of riders opt for traditional bikes; about 8% of riders use the assistive options. Cyclistic users are more likely to ride for leisure, but about 30% use the bikes to commute to work each day.

In 2016, Cyclistic launched a successful bike-share offering. Since then, the program has grown to a fleet of 5,824 bicycles that are geotracked and locked into a network of 692 stations across Chicago. 
The bikes can be unlocked from one station and returned to any other station
in the system anytime.

### Marketing program

Cyclistic’s marketing strategy relied on building general awareness and appealing to broad consumer segments. One approach that helped make these things possible was the
flexibility of its pricing plans: single-ride passes, full-day passes, and annual memberships.
Customers who purchase single-ride or full-day passes are referred to as casual riders.
Customers who purchase annual memberships are Cyclistic members.

### Problem
Cyclistic’s finance analysts have concluded that annual members are much more profitable than casual riders. Although the pricing flexibility helps Cyclistic attract more customers,
Director of marketing believes that maximizing the number of annual members will be key to future growth.
Rather than creating a marketing campaign that targets all-new customers, there is a suggestion to convert casual riders into members. Casual riders are already aware of the Cyclistic program and have chosen Cyclistic for their mobility needs.

## Analysis

Let's put some statistics here for the last 12 months

```{r import trips, include=FALSE}
  trips_july_24 <- read_csv('202407-divvy-tripdata.csv')
```


```{r create a custom columns, include=FALSE}
trips_july_24 <- trips_july_24 %>%
  mutate(
         started_at = ymd_hms (started_at),
         ended_at =ymd_hms (ended_at),
         trip_duration = ended_at - started_at,
         weekday = wday(started_at, label = TRUE),
         start_day = as.Date(started_at)
         )
```


```{r data clean, include=FALSE}
#remove all the trips where coordinates are NA

trips_july_24 <- trips_july_24 %>%
  filter(
    !(trimws(start_lat) == "" | is.na(start_lat) |
        trimws(start_lng) == "" | is.na(start_lng) |
        trimws(end_lat) == "" | is.na(end_lat) |
        trimws(end_lng) == "" | is.na(end_lng)
    )
  )

#remove all the trips where trip duration is less than 60 sec

trips_july_24 <- trips_july_24 %>%
  filter(!trip_duration<60)

#I would rather clarify the trips where start and end station coordinates are same. In my city this is not acceptable. You can not take a bike and give it back at the same station after the trip. Here I see the big ranges of time, so I did not remove those trips.
  
```

### Top-50 start stations (by total amount of rides)

```{r create a top 50 start stations, include=FALSE}
popular_start_stations <- trips_july_24 %>%
  group_by(station_cords = paste(start_lat,start_lng, sep = ":")) %>%
  summarise(
    total_subscriber = sum(member_casual == 'member'),
    total_customer = sum(member_casual == 'casual'),
    total_taken = n()) %>%
  arrange(desc(total_taken)) %>%
  slice_head(n = 50)
```

```{r add lat long by splitting start_lat_long, include=FALSE}
popular_start_stations <- popular_start_stations %>% 
  mutate(
    coord_split = strsplit(station_cords, split = ":"),
    start_lat = sapply(coord_split, function(x) as.double(x[1])),
    start_lng = sapply(coord_split, function(x) as.double(x[2]))
  ) %>%
  select(-coord_split)
```

```{r add percentage of customers, include=FALSE}

popular_start_stations <- popular_start_stations %>% 
  mutate(
    customer_percent = (total_customer/total_taken)*100
  ) 
```

```{r add popularity colors, include=FALSE}

popular_start_stations <- popular_start_stations %>% 
  mutate(
    color = ifelse(customer_percent>=80,"purple",
                   ifelse(customer_percent>=70,"magenta",
                          ifelse(customer_percent>55,"coral",
                                 ifelse(customer_percent>=45,"green",
                                       ifelse(customer_percent>=35,"dodgerblue", 
                                              ifelse(customer_percent>=25,"blue", 
                                                     ifelse(customer_percent>=10,"darkblue", "black")
                                              )
                                       )
                                 )
                          )
                   )
    ),
    customer_top = ifelse(customer_percent>55, TRUE, FALSE)
  ) 
```

```{r draw top 50 start stations on the map, echo=FALSE}

#load map
leaflet(data = popular_start_stations) %>% 
  addTiles() %>% 
  addCircleMarkers(~start_lng, ~start_lat, 
                   radius = ~total_taken/500, 
                   color = ~color,
                   fillOpacity = 0.7,
                   label = ~paste("Customers:", total_customer, "VS",
                                  "Subscribers:", total_subscriber)) %>% 
  addLegend("bottomright", 
            colors = c("purple","magenta","coral","green","dodgerblue","blue","darkblue", "black"),
            labels = c(">80% Customers", "70-80% Customers", "55-70% Customers", "45-55% Customers", "35-45% Customers", "25-35% Customers", "10-25% Customers", "less than 10% Customers"),
            title = "Station Popularity")
```
We can see that piers and lakefronts stations are the most attractive for the customers. Navy Pier Terminal is a Tourists attraction place. If the subscription program is limited only to Chicago, those customers have no option to subscribe for a longer time.
Closer to center the percentage of customers and subscribers becomes 50/50. 
And at the Near West Side we see mainly subscribers.

### Top-10 routes

```{r create a list of top 50 routes, include=FALSE}
top_trips_july_24 <- trips_july_24 %>%
  group_by(trip_coords = 
             paste (
               paste(start_lat,start_lng, sep = ":"),
               paste(end_lat, end_lng, sep = ":"),
               sep = ";"
               )) %>% 
  summarise(total_subscriber = sum(member_casual == 'member'),
            total_customer = sum(member_casual == 'casual'),
            total_trips = n()) %>%
  arrange(desc(total_trips)) %>%
  slice_head(n = 10)
```

```{r add lat long data in top directions, include=FALSE}
top_trips_july_24 <- top_trips_july_24 %>%
  # Create new columns for start and end coordinates
  mutate(
    start_coord = strsplit(trip_coords, split = ";") %>% sapply("[", 1),
    end_coord = strsplit(trip_coords, split = ";") %>% sapply("[", 2)
  ) %>%
  # Separate the start and end coordinates into lat and long
  separate(start_coord, into = c("start_lat", "start_lng"), sep = ":", convert = TRUE) %>%
  separate(end_coord, into = c("end_lat", "end_lng"), sep = ":", convert = TRUE)
```

```{r drawing routes, echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  addTiles() %>% 
  #make it blak&white
  #addProviderTiles(providers$CartoDB.Positron) %>%
  # Set initial view to Chicago with appropriate zoom level
  setView(lng = -87.6298, lat = 41.8781, zoom = 12) %>%
  # Add routes as lines
  addPolylines(
    lng = c(top_trips_july_24$start_lng, top_trips_july_24$end_lng),
    lat = c(top_trips_july_24$start_lat, top_trips_july_24$end_lat),
    group = top_trips_july_24$trip_coords,
    color = "darkblue",
    weight = 3
  ) %>%
  # Add markers at the start and end points
  addCircleMarkers(
    lng = top_trips_july_24$start_lng, 
    lat = top_trips_july_24$start_lat, 
    color = "white", 
    radius = 5 
  ) %>%
  addCircleMarkers(
    lng = top_trips_july_24$end_lng, 
    lat = top_trips_july_24$end_lat, 
    color = "blue", 
    radius = 10
  )

``` 

### Longest rides
```{r longest rides, echo=FALSE}
longest_rides <- trips_july_24 %>%
  group_by(member_casual, rideable_type) %>%
  top_n(1, trip_duration) %>% 
  ungroup()

longest_rides<- longest_rides %>% 
  mutate(
    trip_duration_min= round(as.numeric(trip_duration)/60,0),
    trip_duration_h = trip_duration_min/60
  )

longest_rides <- longest_rides %>% 
  select(member_casual,trip_duration_h, rideable_type, start_day, weekday) %>% 
  arrange(desc(trip_duration_h))

longest_rides %>% 
  kable(format = "html", col.names = c("Customer Type", "Trip Duration", "Bike Type", "Start Day", "Weekday")) %>% 
  kable_paper()
```

### Rides activity
```{r create days activity statistic, include=FALSE}
daily_activity <- trips_july_24 %>%
  group_by(start_day, weekday, rideable_type, member_casual) %>% 
  summarise(total_subscriber = sum(member_casual == 'member'),
            total_customer = sum(member_casual == 'casual'),
            total_trips = n())%>%
  arrange(desc(total_trips))
```


```{r show rides statistic, echo=FALSE}
ggplot(data = daily_activity, aes(x = start_day, y = total_trips, color = member_casual)) +
  geom_line() +
  labs(
    title = "Ride Activity",
    x = "Day",
    y = "Rides",
    color = "Rider Type"
  ) +
  theme_minimal()
```


```{r rides by weekday, echo = FALSE}

bike_labels <- c(
  "classic_bike" = "classic",
  "electric_bike" = "electric"
)

ggplot(data = daily_activity) +
  geom_bar(mapping = aes(x = weekday, y = total_trips, fill = member_casual), position = "dodge", stat = "identity") +
  labs(
    x = "day of week",
    y = "Total rides",
    fill = "Customer type") +
  facet_wrap(~rideable_type, labeller = labeller(rideable_type = bike_labels)) +
  theme_minimal() +
  theme(
    axis.title.x = element_text(size = 10, face = "bold"),
    axis.title.y = element_text(size = 10, face = "bold"),
    strip.text = element_text(size = 12),
  )
```
